피드 시스템은 다양한 SNS나, 포털 사이트에서 활용될 수 있는 시스템이다.
이번 장에서는 트위터나 인스타 같은 SNS를 생각하고 진행해 보겠다.

### 피드의 기능

피드는 팔로우, 팔로워에 대한 포스팅, 포스팅 된 피드, 포스팅 했을 때 알림이 주요 기능이 될 것 같다.

### 문제 요구사항

- 모바일 웹 지원
- 뉴스피드 페이지에 본인의 새로운 스토리 업로드, 팔로우 한 친구의 스토리 보기
- 단순하게 시간 흐름 역순으로 표시
- 한 명의 사용자는 최대 5000명의 친구를 가질 수 있음
- 트래픽 규모 - 매일 천만명 DAU

피드 발행, 뉴스 피드 생성 - 주요 서비스 기능

### 뉴스 피드 API

**피드 발행 API**

`POST /v1/me/feed`

**로드밸런서 → 웹 서버 → 포스팅 저장 서비스, 포스팅 전송 서비스, 알림 서비스**에 각각 보내기

**뉴스 피드 읽기 API**

`GET /v1/me/feed`

**로드밸런서 → 웹 서버 → 뉴스 피드 서비스 → 뉴스 피드 캐시**
뉴스 피드 캐시를 통해 데이터를 가져온다.

### 상세 설계

피드 발행 흐름 설계

### 웹 서버

웹 서버는 클라이언트와 통신할 뿐 아니라 인증이나 처리율 제한 등의 기능도 수행한다. 인증 토큰이 Authorization 헤더가 담겨있어야 하며, 한 사용자가 올릴 수 있는 포스팅 수 제한을 두어야 한다.

### 포스팅 전송(팬아웃) 서비스

- 쓰기 시점에 팬아웃하는 모델(푸시 모델)
    - 장점
        - 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송된다.
        - 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로 뉴스 피드를 읽는 데 드는 시간이 짧아진다.
    - 단점
        - 친구가 많은 사용자는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요될 수 있다.(핫키 문제)
        - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 해서 자원 낭비
- 읽기 시점에 팬아웃하는 모델(풀 모델)
    - 장점
        - 비활성화된 사용자, 또는 서비스에 거의 로그인하지 않는 사용자의 경우에는 컴퓨팅 자원 소모가 적기에 유리한 방법
        - 데이터를 친구 모두에게 푸시하는 작업이 필요없으므로 핫키 문제 발생x
    - 단점
        - 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있다

따라서 장점과 단점을 최대한 수용하기 위해서는 푸시, 풀 모델을 적절히 섞어서 활용해야 할 것이다.

이번 설계에서는 대부분의 사용자에 대해서는 푸시 모델을 사용하며, 친구나 팔로어가 아주 많은 사용자의 경우에는 풀 모델을 사용하여 시스템 과부하를 방지할 것이다.

### **포스팅 전송 서비스**

- 친구 id 목록 추출
    - 그래프 데이터 베이스를 활용해 친구 ID 목록을 가져오기
- 친구 데이터 추출
    - 사용자 정보 캐시에서 친구들의 정보를 가져오기, 사용자 설정에 따라 친구 일부만 가져오기
- 메시지 큐
    - 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣기
- 포스팅 전송 작업 서버
    - 뉴스 피드 데이터를 뉴스 피드 캐시에 넣기. 뉴스 피드 캐시는 <포스팅 ID, 사용자 ID>의 순서쌍을 보관하는 매핑 테이블로, 저장해둔다. 여기에 데이터를 모두 넣지 않은 이유는, 데이터 크기를 관리하기 위해
- 뉴스 피드 캐시
    - 캐시에 보관된 데이터를 꺼내서 뉴스 피드를 렌더링한다

다중화 캐시 서버일 때는 어떻게 할지 이건 발표 당시에 생각해서 얘기하기!! (기억하는 연습)

- 내가 생각했던 정답
    
    해시 방식으로 user_id를 해싱해서 해시망 캐시 서버를 통해 관리! 이는 특정 유저에 대해 동일한 데이터가 들어갈 수 있도록 처리할 수 있음
    

### 뉴스 피드 서비스

로드 밸런서를 통해 분산 웹 서버에 도달

뉴스 피드 서비스 → 뉴스 피드 캐시 → 사용자 정보 캐시(인증, 인가) → 포스팅 캐시 → 포스팅 데이터 베이스

1. 뉴스 피드 캐시 조회
2. 뉴스 피드의 포스트 정보를 가져옴
- 사용자 정보 캐시 → 사용자 정보 DB
- 포스팅 캐시 → 포스팅 DB
3. 생성된 뉴스 피드를 클라이언트에게 반환 - 클라이언트는 해당 데이터 렌더링

### 캐시 구조

뉴스 피드에서 주로 활용하는 캐시 목록 및 계층

- 뉴스 피드
- 콘텐츠
    - 인기 콘텐츠
    - 일반 콘텐츠
- 소셜 그래프
    - 팔로어
    - 팔로잉
- 행동
    - 좋아요
    - 답글
    - 기타
- 횟수
    - 좋아요 횟수
    - 답글 횟수
    - 기타

다루면 좋을 주제

- 수직적 규모 확장 vs 수평적 규모 확장
- SQL vs NoSQL
- master-slave 다중화
- 복제본에 대한 읽기 연산
- 일관성 모델
- 데이터베이스 샤딩

- 웹 계층을 무상태로 운영하기
- 가능한 한 많은 데이터를 캐시할 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭에 대한 모니터링
