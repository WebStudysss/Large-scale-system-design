**키-값 저장소의 용도**

- 캐시 저장소
- 인증, 인가
- 이메일 인증

등의 용도로 활용됨

**키-값 저장소의 요구사항**

- 키-값 쌍의 크기는 10KB 이하
- 큰 데이터를 저장할 수 있어야 한다. - 압축?
- 높은 가용성을 제공해야 한다. 장애가 있어도 빠른 응답 필요
- 높은 확장성 제공 트래픽 양에 따라 자동 서버 증설/삭제 (스케일 인/아웃)
- 데이터 일관성 수준은 조정이 가능해야 함
- 응답 지연시간이 짧아야 함

가장 단순히 생각했을 때의 접근법

- 데이터 압축
- 자주 쓰이는 데이터만 메모리에 두고(캐싱) 나머지는 디스크에 저장

서버 한대로는 결국 한계가 온다 ⇒ 하드웨어적 한계

### 분산 키-값 저장소

분산 K-V 저장소는 분산 해시 테이블이라고도 불리는데, 이러한 분산 시스템 설계의 기본 조건은 CAP 정리 이해를 기반으로 한다.(CAP : Consistency, Availability, Partition Tolerance theorem)

### CAP 정리란?

- C : Consistency 일관성
⇒ 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.
- A : Availability 가용성
⇒ 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.
- P : Partition Tolerance 파티션 감내
    
    ⇒ 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다는 것을 뜻한다.
    

위의 세 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리

따라서, 목적에 따라 두 요구사항을 충족하는 시스템 설계방식으로 분산 설계를 진행한다.

- CP : 일관성 + 파티션 감내
네트워크 분할로 특정 노드에 문제가 생겼을 때 해당 노드의 데이터는 일관성을 위해 반영하지 않음
- AP : 가용성 + 파티션 감내
네트워크 분할로 특정 노드에 문제가 생기면 해당 노드의 변경된 데이터는 동기화되지 않아서 구버전의 데이터를 보일 수도 있음
- CA : 일관성 + 가용성
분산 시스템에서 **Partition은 언젠가 반드시 발생한다고 가정**하므로 해당 케이스는 고려하지 않음

```java
서울 본점과 부산 지점이 있는 은행이 있다고 해요.
평소엔 본점과 지점이 전용 회선으로 연결돼 있어서 “계좌 정보”를 실시간으로 공유합니다.
그런데 서울–부산 회선이 끊겼다! (케이블 단선, 라우터 다운 등)
서울 고객은 여전히 거래 가능
부산 고객도 지점 서버랑만 연결되니 거래 가능

문제: 서로 동기화가 안 되니 같은 계좌에서 두 번 출금될 수 있음
👉 이게 “네트워크 분할(Partition)”입니다.
```

CAP를 지키기 위해 활용되는 시스템 컴포넌트 및 기술

- 데이터 파티션
    - 데이터를 여러 서버에 분할해서 넣어둔다.
    - 고려점 : 데이터를 여러 서버에 고르게 분산할 수 있는가, 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는
    
    ⇒안정 해시 방법을 활용해 해시 망을 구축 후 이용
    
    장점 : 규모 확장 자동화(automatic scaling), 각 서버의 용량에 맞게 가상노드의 수 조절
    
- 데이터 다중화(replication)
    - 높은 가용성을 위해 n개 서버에 비동기적으로 다중화 → 동일한 물리서버가 채택되지 않도록 하며, n개의 서버에 데이터 사본 보관
- 일관성(consistency)
    - 여러 노드에 다중화된 데이터는 적절히 동기화가 되어야 한다. 정족수 합의(Quorum Consensus) 프로토콜을 사용해 읽기/쓰기 연산 모두에 일관성 보장
    - N, W, R 기준으로 Write와 Read 정족수 기준 - w개,r개의 서버로부터 쓰기, 읽기 연산이 성공했다는 응답을 받아야함
    - 중재자(coordinator)가 W, R의 수를 확인해 검증 및 컨트롤해주는 역할 - 프록시로 봐도 됨
    - W + R > N일 때 강한 일관성이 보장됨
    - 면접 시 어떻게 값을 정하는 것이 좋을까?
        - R = 1, W=N : 빠른 읽기 연산에 최적화된 시스템
        - W = 1, R = N : 빠른 쓰기 연산에 최적화된 시스템
        - W + R > N : 강한 일관성이 보장됨(보통 N = 3, W = R = 2)
        - W + R ≤ N : 강한 일관성이 보장되지 않음
        
        ⇒ 요구되는 일관성 수준에 따라 W, R, N의 값을 조정하기
        
- 일관성 불일치 해소(inconsistency resolution)
    - 일관성 수준
        - 강한 일관성 : 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다. 클라이언트는 낡은 데이터를 보지 못함
        - 약한 일관성 : 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
        - 최종 일관성 : 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영(동기화)되는 모델이다.
    - 강한 일관성을 달성하는 일반적인 방법 : 모든 사본에 현재 쓰기 연산의 결과가 반영될 때까지 해당 데이터에 대한 읽기/쓰기를 금지하는 것
    - 비 일관성 해소 기법 : 데이터 버저닝
        - 일관성이 깨지는 문제를 해소하기 위해 데이터가 변경될 때마다 해당 데이터의 새로운 버전을 만드는 것 → 각 버전의 데이터는 변경 불가능해야한다.
        - 벡터 시계 : 데이터 값이 각 서버간 불일치할 때 버저닝 문제를 위해 사용되는 기술 서버, 버전의 순서쌍으로 보관
    - 해당 벡터시계 해소 기법은 강한 일관성을 보장하는 기법은 아니다 - 은행같은 곳에서는 활용 불가능
- 장애 처리
    - 장애 감지
        - 두 대 이상의 서버가 동일하게 특정 서버에 장애가 생겼다고 확인되어야 장애가 발생했다고 간주한다.
        - 모든 노드에 채널을 구축하는 멀티캐스팅 기법이 있지만, 서버가 너무 많아지면 비효율적이다.
        - 가십 프로토콜을 주로 활용한다.(타임스탬프 기법)
        
        ⇒ 가십 프로토콜(gossip protocol)같은 분산형 장애 감지(decentralized failure detection) 솔루션을 채택
        
    - 일시 장애 처리
        - 임시로 장애 서버로 가는 데이터를 정상 서버에서 가져간다
    - 영구 장애 처리
        - 머클 해시트리 방식
        각 서버를 일정 대수 해시 트리형태로 변경

CAP 관련 사용 사례

```java
📌 CAP 정리 사례 정리
1. CP (Consistency + Partition Tolerance)

👉 일관성을 우선하고, 네트워크 분할이 생기면 가용성을 희생 (일부 요청 거부/대기)

예시 시스템
HBase (Hadoop 기반 분산 DB)
MongoDB (replica set, majority write concern)
Zookeeper / etcd / Consul (분산 합의, 리더 선출)
Redis Sentinel (failover 중)

사용 사례
금융/거래 시스템 (은행 잔액, 결제 등)
리더 선출/락 관리(분산 합의)
반드시 정합성이 보장돼야 하는 데이터

2. AP (Availability + Partition Tolerance)

👉 가용성을 우선하고, 일관성은 나중에(Eventual Consistency)

예시 시스템
Amazon DynamoDB (Dynamo 원조 모델)
Cassandra
Riak
DNS 시스템

사용 사례
SNS 피드, 쇼핑몰 상품 추천, 로그 수집 등
“조금 늦게 최신화돼도 괜찮은” 서비스
고가용성이 최우선인 글로벌 분산 시스템

3. CA (Consistency + Availability)

👉 분할 내성(P)을 고려하지 않음 → 이론상만 가능, 분산 시스템에서는 사실상 불가능
(네트워크 장애가 없는 단일 노드/단일 데이터센터 환경이라면 가능)

예시 시스템
단일 노드 RDBMS (MySQL, PostgreSQL)
네트워크 분할이 없는 환경의 중앙 집중식 시스템

사용 사례
작은 규모의 단일 서버 애플리케이션
로컬 환경 테스트

📌 쉽게 비유하면

CP: "돈 이체는 정확해야 하니까, 네트워크 문제가 있으면 서비스 일시 중단하자"
AP: "트위터 좋아요 수는 조금 늦게 맞춰져도 괜찮아, 대신 서비스는 계속 돌아가야지"
CA: "우리 서비스는 단일 서버니까 둘 다 가능" (→ 하지만 분산 환경에서는 불가)

✅ 정리

CP → HBase, Zookeeper, etcd → 강한 일관성 필요할 때
AP → Cassandra, DynamoDB, Riak → 고가용성 필요할 때
CA → 단일 노드 DB → 분산 시스템에서는 현실적으로 불가
```
