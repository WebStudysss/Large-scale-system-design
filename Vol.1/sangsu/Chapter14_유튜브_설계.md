### 요구사항

- 비디오 올리는 기능, 비디오 시청하는 기능
- 다국어 지원
- 비디오 종류, 해상도 모두 지원
- 암호화
- 비디오 크기 1GB 제한
- 클라우드 서비스를 활용 여부

**컴포넌트 구분**

- 로드밸런서
- API 서버
- 메타데이터 데이터베이스
- 메타데이터 캐시
- 원본 저장소
- 트랜스코딩 서버
- 트랜스코딩 비디오 저장소 : BLOB
- CDN
- 트랜스코딩 완료 큐
- 트랜스코딩 완료 핸들러

### 비디오 업로드

비디오를 업로드하게 되면, 비디오의 메타데이터를 저장, 캐싱하고, 해당 영상을 원하는 포맷에 맞게 트랜스코딩을 진행한다.

트랜스 코딩이 완료되면, 트랜스코딩 된 영상은 BLOB에 보관하며 CDN 캐싱해둔다. 추가로 트랜스코딩 완료 핸들러가 메타데이터를 추가로 업데이트한다.

### 비디오 스트리밍

스트리밍 프로토콜은 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이다.

**대표적인 스트리밍 프로토콜**

- MPEG-DASH(Moving Picture Experts Group - Dynamic Adaptive Streaming over HTTP
- HLS(Http Live Streaming)
- MSS(Microsoft Smooth Streaming)
- ADS(Adobe HTTP Dynamic Streaming)

설계를 위해서는 위의 프로토콜의 동작 원리를 알 필요는 없지만, 지원하는 인코딩 등이 다르고, 플레이어도 다르다. 따라서 인코딩과 맞는 프로토콜을 잘 선택해서 얘기하는 것이 좋다.

비디오는 사용자 단말에서 CDN으로 즉시 요청해서 스트리밍 될 것이다.

### 비디오 트랜스코딩

다양한 브라우저에서 재생이 가능한 영상이 되기 위해서는 하나의 영상이 다양한 포맷과 비트레이트로 이루어져 있어야 한다.

따라서 비디오 트랜스코딩 컴포넌트의 역할은 다음과 같다.

- 영상의 포맷을 다양하게 인코딩
- 영상의 비트레이트를 다양하게 인코딩

비디오의 인코딩 포맷 기준은 다음과 같다.

- 컨테이너(container) : 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 존재 .avi, mp4, mov 등
- 코덱(codec) : 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘 - H264, VP9, HEVC 등

### 유향 비순환 그래프(DAG) 모델

비디오 트랜스코딩 파이프라인 중  비디오 인코딩에 추가 가공작업을 하는 것을 뜻한다.

- 검사
- 인코딩
    - 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩하는 작업 (360p.mp4, 720p.mp4 등)
- 섬네일 추출
- 워터마크 비디오에 대한 식별정보를 이미지 위에 오버레이 형태로 띄워 표시하는 작업

### 비디오 트랜스코딩 아키텍처

다섯 개의 주요 컴포넌트로 구성된다. 전처리기, DAG 스케줄러, 자원 관리자, 작업 실행 서버, 임시 저장소가 있다.

**전처리기**

- 비디오 분할 : 비디오 스트림을 GOP(Group of Picture)라고 불리는 단위로 쪼갠다.
- DAG 생성 : 클라이언트 프로그래머가 작성한 프로그래머가 원하는 방식의 DAG 흐름을 만들어낸다
- 데이터 캐시 : 전처리기는 분할된 비디오의 캐시이기도 하다. 메타데이터와 GOP를 캐시해두며, 인코딩이 실패했을 때 해당 캐시를 활용해 재시도할 수 있다.

**DAG 스케줄러**

DAG 그래프를 여러 단계로 분할한 후 각각 자원 관리자의 작업 큐에 집어넣는다

**자원 관리자**

- 작업 스케줄러 : 최적의 작업/서버 조합을 골라 해당 작업 서버가 작업하도록 지시
- 작업 큐 : 실행할 작업이 보관되어 있는 우선순위 큐
- 작업 서버 큐 : 가용 상태 정보가 보관되어 있는 우선순위 큐
- 실행 큐 : 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 일반 큐

**작업 할당 흐름**

1. 작업 큐에서 가장 높은 우선순위 작업을 꺼냄
2. 해당 작업을 실행하기 적합한 작업 서버를 고름
3. 해당 작업 서버에게 작업 실행을 지시
4. 해당 작업이 어떤 서버에게 할당되었는지에 대한 정보를 실행 큐에 넣음
5. 작업이 완료되면 해당 작업을 실행 큐에서 제거

**작업 서버**

DAG에 정의된 작업을 수행한다. 작업 종류에 따라 작업 서버도 구분하여 관리

- 워터마크, 인코딩, 썸네일, 병합

작업 서버를 거쳐서 작업이 완료되면 최종적으로 인코딩된 비디오가 생성된다.

### 시스템 최적화

- 비디오 병렬 업로드
    - GOP에 맞춰
- 업로드 센터를 사용자 근거리에 지정
    - 업로드 하는 센터를 여러곳에 둔 후 근거리 센터로 영상 업로드가 되도록 유도하는 것
- 모든 절차를 병렬화
    - 메시지 큐를 각 모듈별로 도입
- 영상 업로드 속도 최적화
    - 브라우저의 청크 업로드 기능 지원
- 미리 사인된 업로드 URL
    - 영상을 사용자가 업로드 위치에 저장할 수 있도록 URL 제공
- 비디오 보호
    - DRM 시스템 도입
        - 영상 잠금
    - AES 암호화
        - 비디오는 재생 시에만 복호화한다
    - 워터마크
        - 소유자 정보를 비디오 위에 표시
- 비용 최적화
    - 비디오 스트리밍은 롱테일 분포를 따름
        - 따라서 인기 많은 비디오는 CDN
        - 그 외 비디오는 비디오 서버

### 오류 처리

- 회복 가능 오류(recoverable error) : 특정 비디오 세그먼트를 트랜스코딩하다 실패하는 오류는 회복 가능한 오류에 속한다 이런 오류는 재시도하면 일반적으로 해결되며, 계속 실패하면 클라이언트에게 적절한 오류 코드를 반환해야 한다.
- 회복 불가능 오류(noon-recoverable error) : 비디오 포맷이 잘못되었다거나 회복 불가능한 오류가 발견되면, 클라이언트에게 적절한 오류 코드를 반환해야 한다.

전형적인 오류 케이스

- 업로드 오류 : 몇 회 재시도
- 비디오 분할 오류 : 낡은 버전의 클라이언트가 GOP 경계에 따라 비디오를 분할하지 못하는 경우에는 서버에 전체 비디오를 전송
- 트랜스코딩 오류 : 재시도
- 전처리 오류 : DAG 그래프 재생성
- DAG 스케줄러 오류 : 작업을 다시 스케줄링
- 자원 관리자 큐에 장애 발생 : 사본을 이용
- 작업 서버 장애 : 다른 서버에서 해당 작업 재시도

### 추가 논의 사항

HLS 프로토콜에 대하여.
비교적 자주 활용되는 것으로 보이는 HLS 프로토콜의 추가 조사

```java
[Client/HLS Player] 
      │
      │ 1. HTTP GET /master.m3u8
      ▼
[Web Server/CDN]
      │
      │ 2. Return m3u8 playlist
      ▼
[Client] --- 파싱 ---> (m3u8 파일, #EXTINF, segment URIs)
      │
      │ 3. HTTP GET /segment1.ts
      ▼
[Web Server/CDN]
      │
      │ 4. Return segment1.ts data
      ▼
[Client]
      │  (재생 시작)
      │
      │ 5. HTTP GET /segment2.ts ...
      ▼
[Web Server/CDN]
      │
      │ 6. Return segment2.ts data ...
      ▼
[Client] (연속 재생)

```
