### 요구사항

- 파일 업로드/다운로드, 파일 동기화, 알림
- 파일 크기 10GB 제한
- 모바일 웹 모두 지원
- DAU 천만

- 기능
    - 파일 추가
    - 파일 다운로드
    - 여러 단말 파일 동기화. 다른 단말에도 자동 동기화
    - 파일 갱신 이력 조회
    - 파일 공유
    - 파일이 편집되거나 삭제되거나 새롭게 공유되었을 때 알림 표시
- 비기능 요구사항
    - 안정성 - 데이터 손실 x
    - 빠른 동기화 속도
    - 네트워크 대역폭
    - 규모 확장성
    - 높은 가용성

### 추정치

- 가입 사용자는 오천만, DAU 천만명
- 모든 사용자에게 10GB 무료 저장공간 할당
- 매일  각 사용자가 평균 2개의 파일을 업로드하며, 평균 크기 500KB
- 읽기 쓰기 비율 1:1
- 저장공간 총량 = 5천만 * 10GB = 500PB
- 업로드 API QPS = 1천만 * 2회 업로드/24/3600 = 240

**서버 한 대에서 시작!**

- 웹 서버
- 데이터 베이스
- 파일을 업로드할 디렉토리 준비

**API**

- 파일 업로드 API
    - 단순 업로드
    - 이어 올리기
        - ex) file/upload?uploadType=resumable
        - 업로드에 장애가 발생하면 장애 발생시점부터 업로드 재시작
- 파일 다운로드 API
    - response : path값
- 파일 갱신 히스토리 API
    - 인자 : path, limit

### 용량이 부족하다.

1. 스토리지를 user_id 기준으로 샤딩
2. 아마존 S3 서비스를 통해 가용성, 확장성, 보안을 챙김

### 트래픽은?

로드밸런서를 도입해 웹 서버를 추가

**블록 저장소 서버**

사용자가 업로드 했을 때 블록 단위로 업로드를 받으며, 업로드 실패 시 이어서 받을 수 있도록 구현된 서버, 업로드가 완료되면 해당 파일은 S3(클라우드)저장소로 이동

델타 동기화 : 파일이 수정되었을 때 전체 파일 대신 수정이 일어난 블록만 동기화

압축 : 블록 단위로 압축해 두면 데이터 크기를 많이 줄일 수 있다.

높은 일관성을 요구하기에 ACID를 지원하는 RDBMS를 사용

**업로드 절차**

- 파일 메타데이터 추가
    - 클라이언트 1이 새 파일의 메타데이터를 추가하기 위한 요청 전송
    - 새 파일의 메타데이터를 데이터베이스에 저장하고 상태를 변경
    - 새 파일이 추가되었음을 알림 서비스에 통지
    - 알림 서비스는 관련 클라이언트에게 파일이 업로드되었음을 알림
- 파일을 클라우드 저장소에 업로드
    - 블록 저장소 서버에 파일을 업로드
    - 블록 저장소 서버는 파일을 블록 단위로 쪼갠 후 압축 및 암호화, 클라우드 전송
    - 업로드가 끝나면 클라우드 스토리지로 완료 콜백 호출
    - 해당 파일 상태 완료로 업로드

### 알림 서비스

활용 방식

- 롱 폴링
- 웹 소켓

### 저장소 공간 절약

- 중복 제거
- 지능적 백업 전략
- cold 스토리지 도입
