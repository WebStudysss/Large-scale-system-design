# ch1. 근접성 서비스
QPS 계산은 1일 = `24H*60M*60S`초, 대략 100,000로 즉 10^5로 올림해서 하루는 10^5로 두고 계산한다.

### API 설계
검색 결과는 보통 페이지 단위로 나눠 반환한다.<br> API 호출 시 전달할 인자(parameter)는 각 도메인마다 다르다.

<hr>

#### 읽기/쓰기 비율
읽기 연산은 굉장이 자주 수행되는데,
- 주변 사업장 검색
- 사업장 정보 확인

때문에 자주 수행된다.
<br>반면에 쓰기 연산의 실행 빈도는 낮다. 정보를 추가하거나 삭제, 편집하는 행위는 빈번하지 않기 때문이다.

## 스키마 설계
### 데이터 스키마
- 지리적 위치 색인 테이블<br>
지리적 위치 색인 테이블은 위치 정보 관련 연산의 효율성을 높이는 데 쓰인다.<br> 지오해시에 대한 지식이 필요함(db규모 확장 절 확인).

## 개략적 설계
### 로드밸런서
- 단일 DNS 진입점(entry point)을 지정하고, url 경로를 분석하여 어느 서비스에 트래픽을 전달할지 결정한다

### 위치 기반 서비스 (LBS)
- 주어진 위치와 반경 정보를 이용해 주변 사업장을 검색한다. 
- 특징
  - 쓰기 요청이 없는, 읽기 요청만 빈번하게 발생
  - QPS 높음. 특히 특정 시간대의 인구 밀집 지역일수록 그 경향이 심하다.
  - stateless 서비스이므로 수평적 규모 확장이 쉽다.

### 사업장 서비스
- 사업장 소유주가 사업장 정보를 생성,갱신,삭제한다.<br> 기본적으로 쓰기 요청이며, QPS 높음
- 고객이 사업장 정보를 조회, 특정 시간대에 QPS 높아진다.

### DB 클러스터
주-부 데이터베이스 형태로 구성할 수 있으며, 주 db는 write, 부 db는 read를 처리한다.<br>
즉, data는 주 데이터에 일단 기록되고난 후에 사본 db로 복사된다.<br>
복제에 걸리는 시간 delay 때문에 주 db data와 사본 db data 사이에는 차이가 있을 수 있다.<br>

### 확장성
사업장 서비스와 LBS는 둘 다 stateless 서비스이므로 점심시간 등의 특정 시간대에 집중적으로 몰리는 트래픽에는 자동으로 서버를 추가하여 대응하고, 야간 등 유휴 시간 대에는 서버를 삭제하도록 구성할 수 있다.<br>
시스템을 클라우드에 둔다면 여러 지역, 여러 가용성 구역에 서버를 두어 시스템 가용성을 높일 수 있다.

### 면접관의 입장
면접관들이 신입 개발자에게 사실상 db의 내부 구조를 알 거라고 기대하지는 않는다.<br> 그러니 db의 이름을 나열하기 보다는 지리적 위치 색인이 어떻게 동작하는지 설명함으로써 문제 풀이 능력과 기술적 지식을 갖추었음을 보이는 것이 더 좋다.<br>

2차원적인 데이터는 칼럼별로 가져온 결과도 엄청난 양일 것이다.<br>
그래서 위도와 경도 칼럼에 색인을 만들어도 그닥 효율적이지 않다.
<br><b>즉, DB 색인으로는 오직 1 차원의 검색 속도만 개선할 수 있다는 것이다.</b>

그러니 자연스레 2차원 데이터를 1차원에 대응시킬 수 있는 방법이 없을까?를 생각하게 된다.<br>
지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만드는 것이다.(지오해시, 쿼드트리, 구글S2가 자주 쓰임)<br>

> 면접 시에는 각 인덱스 방안의 구현 세부까지 설명할 필요는 없다.<br> But, 그에 관한 기본 지식은 갖춰야한다. 개략적으로 어떻게 동작하고, 제약사항이 무엇인지 정도는 파악하자.

### 1. 2차원 검색
### 2. 균등 격자
### 3. 지오 해시
<br>- 격자 가장자리 이슈 1,2, 표시할 사업장이 충분하지 않은 경우
### 4. 쿼드 트리
#### 쿼드 트리 알고리즘 ?

<b>쿼드 트리 인덱스가 메모리를 많이 잡아먹지 않으므로 서버 한 대에 충분히 올릴 수 있다는 점만  확실히 알아두면 된다.</b><br>
-> 그렇다면, 한 대 서버만 써야 할까? -> 그렇지 않다. -> 읽기 연산 양이 많아지면 서버 한 대의 cpu나 network 대역폭으로는 감당하기 어렵기 떄문이다. (읽기 연산을 여러 대 쿼드트리 서버로 분산해야한다)<br>

#### 쿼드트리로 주변 사업장을 검색하려면?
1. 메모리에 쿼드트리 인덱스를 구축한다.
2. 검색 시작점이 포함된 말단 노드를 만날 때까지, 트리의 루트 노드부터 탐색한다.<br> 해당 노드에 100개 사업장이 있는 경우에는 해당 노드만 반환한다.<br> 그렇지 않은 경우에는 충분한 사업장 수가 확보될 때까지 인접 노드도 추가한다.


### 5.구글 S2

### 지오해시 vs 쿼드 트리



#### 읽어보면 좋은 포스팅
- https://kking.tistory.com/56